name: CI

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: macos-latest
            compiler: gcc

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          /tmp/deps
          ~/deps
        key: ${{ runner.os }}-deps-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          ${{ runner.os }}-deps-

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          unixodbc \
          unixodbc-dev \
          libsqlite3-dev \
          lcov \
          pkg-config

    - name: Install C++ dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        # Create deps directory
        mkdir -p /tmp/deps
        export CMAKE_PREFIX_PATH=/usr/local

        # Check if already cached
        if [ ! -f "/usr/local/lib/libfmt.a" ]; then
          echo "Building fmt..."
          cd /tmp/deps
          git clone --depth 1 --branch 10.1.1 https://github.com/fmtlib/fmt.git
          cd fmt
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DFMT_TEST=OFF -DFMT_DOC=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          sudo cmake --build build --target install
        fi

        if [ ! -f "/usr/local/lib/libspdlog.a" ]; then
          echo "Building spdlog..."
          cd /tmp/deps
          git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git
          cd spdlog
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DSPDLOG_BUILD_EXAMPLE=OFF -DSPDLOG_BUILD_TESTS=OFF
          sudo cmake --build build --target install
        fi

        if [ ! -f "/usr/local/lib/libgtest.a" ]; then
          echo "Building GoogleTest..."
          cd /tmp/deps
          git clone --depth 1 --branch v1.14.0 https://github.com/google/googletest.git
          cd googletest
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_GMOCK=ON -DINSTALL_GTEST=ON
          sudo cmake --build build --target install
        fi

        sudo ldconfig

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install \
          cmake \
          unixodbc \
          sqlite3 \
          spdlog \
          fmt \
          googletest \
          lcov

    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV
        elif [ "${{ matrix.compiler }}" = "clang" ]; then
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
        fi

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_COMPILER=${{ env.CXX }} \
          -DCMAKE_C_COMPILER=${{ env.CC }}

    - name: Build
      run: |
        cmake --build build --config Debug -j2

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Generate coverage report (Linux only)
      if: runner.os == 'Linux' && matrix.compiler == 'gcc'
      run: |
        cd build
        make coverage || true

    - name: Upload coverage to Codecov (Linux only)
      if: runner.os == 'Linux' && matrix.compiler == 'gcc'
      uses: codecov/codecov-action@v4
      with:
        files: ./build/coverage/coverage_final.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.compiler }}
        path: |
          build/bin/
          build/coverage/
        retention-days: 30

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=all \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --inline-suppr \
          --error-exitcode=0 \
          --std=c++17 \
          -I include/ \
          src/ \
          2>&1 | tee cppcheck-report.txt

        # Check for actual errors (not warnings)
        if grep -E "\[error\]" cppcheck-report.txt; then
          echo "Critical errors found!"
          exit 1
        fi

    - name: Upload cppcheck report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
        retention-days: 30

  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          unixodbc \
          unixodbc-dev \
          libsqlite3-dev \
          doxygen \
          graphviz

    - name: Install minimal C++ dependencies
      run: |
        # Install fmt
        cd /tmp
        git clone --depth 1 --branch 10.1.1 https://github.com/fmtlib/fmt.git
        cd fmt
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DFMT_TEST=OFF -DFMT_DOC=OFF
        sudo cmake --build build --target install

        # Install spdlog
        cd /tmp
        git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git
        cd spdlog
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DSPDLOG_BUILD_EXAMPLE=OFF
        sudo cmake --build build --target install

    - name: Configure CMake
      run: |
        cmake -B build -DBUILD_TESTING=OFF

    - name: Generate documentation
      run: |
        cd build
        make doc

    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/doxygen/html/
        retention-days: 30

    - name: Deploy to GitHub Pages (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/doxygen/html
        publish_branch: gh-pages
        force_orphan: true
