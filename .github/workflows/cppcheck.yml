name: Static Analysis (cppcheck)

on:
  push:
    branches: [ main, develop, claude/** ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.hpp'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.hpp'

jobs:
  cppcheck:
    name: cppcheck Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck - Error check
      run: |
        echo "Running cppcheck with error detection..."
        cppcheck \
          --enable=warning,style,performance,portability \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --inline-suppr \
          --std=c++17 \
          --template='{file}:{line}:{severity}:{message}' \
          -I include/ \
          src/ \
          2>&1 | tee cppcheck-errors.txt

        # Check if there are any errors (not warnings)
        if grep -E "(error)" cppcheck-errors.txt; then
          echo "❌ cppcheck found errors!"
          exit 1
        else
          echo "✅ No errors found by cppcheck"
        fi

    - name: Run cppcheck - Full analysis
      if: always()
      run: |
        echo "Running full cppcheck analysis..."
        cppcheck \
          --enable=all \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --inline-suppr \
          --std=c++17 \
          --template='{file}:{line}:{severity}:{message}' \
          --xml \
          --xml-version=2 \
          -I include/ \
          src/ \
          2> cppcheck-full.xml

    - name: Generate cppcheck HTML report
      if: always()
      run: |
        sudo apt-get install -y cppcheck-htmlreport || true
        if command -v cppcheck-htmlreport &> /dev/null; then
          cppcheck-htmlreport \
            --file=cppcheck-full.xml \
            --report-dir=cppcheck-html \
            --source-dir=.
        fi

    - name: Upload cppcheck results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: cppcheck-results
        path: |
          cppcheck-errors.txt
          cppcheck-full.xml
          cppcheck-html/
        retention-days: 30

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let report = '## cppcheck Static Analysis Report\n\n';

          try {
            const errors = fs.readFileSync('cppcheck-errors.txt', 'utf8');
            if (errors.trim()) {
              report += '### Issues Found:\n```\n' + errors + '\n```\n';
            } else {
              report += '✅ No issues found!\n';
            }
          } catch (e) {
            report += '⚠️ Could not read cppcheck results\n';
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
