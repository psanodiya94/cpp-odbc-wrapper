name: Pre-commit Checks

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  pre-commit:
    name: Pre-commit Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check file formatting
      run: |
        echo "Checking for trailing whitespace..."
        if find src include -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) -exec grep -l '[[:space:]]$' {} \; | grep .; then
          echo "❌ Found trailing whitespace in source files"
          find src include -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) -exec grep -Hn '[[:space:]]$' {} \;
          exit 1
        else
          echo "✅ No trailing whitespace found"
        fi

    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        TODOS=$(find src include -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) -exec grep -Hn 'TODO\|FIXME' {} \; || true)
        if [ ! -z "$TODOS" ]; then
          echo "⚠️ Found TODO/FIXME comments:"
          echo "$TODOS"
        else
          echo "✅ No TODO/FIXME comments found"
        fi

    - name: Check CMake files
      run: |
        echo "Validating CMakeLists.txt files..."
        for cmake_file in $(find . -name "CMakeLists.txt"); do
          if ! grep -q "cmake_minimum_required" "$cmake_file"; then
            echo "❌ $cmake_file missing cmake_minimum_required"
            exit 1
          fi
        done
        echo "✅ CMake files validated"

    - name: Check include guards
      run: |
        echo "Checking include guards..."
        MISSING_GUARDS=0
        for header in $(find include -name "*.h" -o -name "*.hpp"); do
          if ! grep -q "#ifndef" "$header" || ! grep -q "#define" "$header" || ! grep -q "#endif" "$header"; then
            echo "❌ $header missing proper include guards"
            MISSING_GUARDS=1
          fi
        done
        if [ $MISSING_GUARDS -eq 0 ]; then
          echo "✅ All headers have include guards"
        else
          exit 1
        fi

    - name: Check for license file
      run: |
        echo "Checking for license information..."
        if [ ! -f "LICENSE" ]; then
          echo "⚠️ No LICENSE file found"
        else
          echo "✅ LICENSE file found"
        fi
